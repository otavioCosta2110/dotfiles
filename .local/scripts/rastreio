#!/usr/bin/env python3
import sys
import requests
import json

def rastrear_wonca(codigo):
    """API Wonca Labs - Rastreamento"""
    url = "https://api-labs.wonca.com.br/wonca.labs.v1.LabsService/Track"
    api_key = "5xDV-Iwjawq3BmD0v7o-CUcVcPTyMtiVuRj4G892sy4"  # Substitua pela sua chave da API
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Apikey {api_key}"
    }
    data = {"code": codigo}
    
    try:
        response = requests.post(url, json=data, headers=headers, timeout=10)
        response.raise_for_status()  # Levanta exceção para erros HTTP
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"❌ Erro na requisição: {e}")
        return None
    except ValueError as e:
        print(f"❌ Erro ao decodificar JSON: {e}")
        return None

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Uso: ./rastreio <codigo>")
        sys.exit(1)

    codigo = sys.argv[1]

    print(f"🔍 Rastreando código: {codigo}")
    
    resultado = rastrear_wonca(codigo)
    
    if resultado:
        print("✅ Dados recebidos com sucesso!")
        print(f"📦 Código: {codigo}")

        # Parse the inner JSON
        try:
            dados = json.loads(resultado['json'])
            print(f"📋 Tipo: {dados.get('tipoPostal', {}).get('descricao', 'N/A')}")
            print(f"📅 Data prevista: {dados.get('dtPrevista', 'N/A')}")

            if 'eventos' in dados and dados['eventos']:
                print("\n📜 Histórico de rastreamento:")
                for evento in dados['eventos']:
                    data = evento.get('dtHrCriado', {}).get('date', 'N/A')
                    descricao = evento.get('descricao', 'N/A')
                    if evento.get('unidade'):
                        endereco = evento['unidade'].get('endereco', {})
                        local = f"{endereco.get('cidade', '')}, {endereco.get('uf', '')}".strip(', ')
                    else:
                        local = 'N/A'
                    print(f"  📅 {data} - 📍 {local} - 🔍 {descricao}")
            else:
                print("ℹ️  Nenhum evento encontrado")
        except json.JSONDecodeError:
            print("❌ Erro ao parsear resposta JSON")
            print(f"Resposta completa: {resultado}")
    else:
        print("❌ Falha ao obter dados de rastreamento")
