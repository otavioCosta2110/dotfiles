#!/usr/bin/env python3
import sys
import requests
import json

def rastrear_wonca(codigo):
    """API Wonca Labs - Rastreamento"""
    url = "https://api-labs.wonca.com.br/wonca.labs.v1.LabsService/Track"
    api_key = "5xDV-Iwjawq3BmD0v7o-CUcVcPTyMtiVuRj4G892sy4"  # Substitua pela sua chave da API
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Apikey {api_key}"
    }
    data = {"code": codigo}
    
    try:
        response = requests.post(url, json=data, headers=headers, timeout=10)
        response.raise_for_status()  # Levanta exceÃ§Ã£o para erros HTTP
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"âŒ Erro na requisiÃ§Ã£o: {e}")
        return None
    except ValueError as e:
        print(f"âŒ Erro ao decodificar JSON: {e}")
        return None

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Uso: ./rastreio <codigo>")
        sys.exit(1)

    codigo = sys.argv[1]

    print(f"ğŸ” Rastreando cÃ³digo: {codigo}")
    
    resultado = rastrear_wonca(codigo)
    
    if resultado:
        print("âœ… Dados recebidos com sucesso!")
        print(f"ğŸ“¦ CÃ³digo: {codigo}")

        # Parse the inner JSON
        try:
            dados = json.loads(resultado['json'])
            print(f"ğŸ“‹ Tipo: {dados.get('tipoPostal', {}).get('descricao', 'N/A')}")
            print(f"ğŸ“… Data prevista: {dados.get('dtPrevista', 'N/A')}")

            if 'eventos' in dados and dados['eventos']:
                print("\nğŸ“œ HistÃ³rico de rastreamento:")
                for evento in dados['eventos']:
                    data = evento.get('dtHrCriado', {}).get('date', 'N/A')
                    descricao = evento.get('descricao', 'N/A')
                    if evento.get('unidade'):
                        endereco = evento['unidade'].get('endereco', {})
                        local = f"{endereco.get('cidade', '')}, {endereco.get('uf', '')}".strip(', ')
                    else:
                        local = 'N/A'
                    print(f"  ğŸ“… {data} - ğŸ“ {local} - ğŸ” {descricao}")
            else:
                print("â„¹ï¸  Nenhum evento encontrado")
        except json.JSONDecodeError:
            print("âŒ Erro ao parsear resposta JSON")
            print(f"Resposta completa: {resultado}")
    else:
        print("âŒ Falha ao obter dados de rastreamento")
